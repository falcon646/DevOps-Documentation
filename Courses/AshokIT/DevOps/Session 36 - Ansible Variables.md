# Ansible Variables

In Ansible, variables allow you to store and reuse values across your playbooks. Variables can be defined at different levels, such as host variables, group variables, and playbook variables. Here are some common types of Ansible variables:

1. Host Variables:
Host variables are specific to individual hosts. They are defined in inventory files or dynamically generated by inventory plugins.
Example (inventory file):

    ```ini
    [web_servers]
    server1 ansible_ssh_user=ec2-user ansible_ssh_host=123.456.789.012
    ```
    In this example, ansible_ssh_user and ansible_ssh_host are host variables.

2. Group Variables:
Group variables are applied to groups of hosts. They are defined in inventory files or in separate variable files within the group_vars directory.
Example (group variable file):

    ```yaml
    # group_vars/web_servers.yml
    ---
    nginx_version: 2.4.6
    ```
    In this example, nginx_version is a group variable applied to the web_servers group.

3. Playbook Variables:
Playbook variables are defined within the playbook itself and are specific to that playbook.
Example (playbook variable):

    ```yaml
    ---
    - name: Example Playbook
      hosts: web_servers
      vars:
        http_port: 8080
      tasks:
        - name: Display variable
          debug:
            var: "{{ http_port }}"
    ```
    In this example, http_port is a playbook variable.

4. Fact Variables:
Facts are pieces of information gathered from target hosts during playbook execution. They are accessible through the ansible_facts dictionary.
Example (using a fact variable):

    ```yaml
    ---
    - name: Gather Facts Example
      hosts: web_servers
      tasks:
        - name: Display hostname
          debug:
            var: ansible_facts['hostname']
    ```
    In this example, ansible_facts['hostname'] is a fact variable representing the hostname of the target host.

5. Special Variables:
Ansible provides a set of special variables that contain information about the playbook, host, and execution context.
Example (using a special variable):

    ```yaml
    ---
    - name: Display playbook name
      hosts: localhost
      tasks:
        - name: Display playbook name
          debug:
            var: playbook_name
    ```
    In this example, playbook_name is a special variable.

Variables enhance the flexibility and reusability of your playbooks by allowing you to parameterize and customize your tasks. Always refer to the Ansible documentation for more details and best practices on using variables in Ansible.

## Referencing Variables
referencing variables is done using the {{ ... }} syntax within tasks, templates, or any other places where Jinja2 templating is supported.

 Here are examples of how variables are referenced in Ansible:

1. Referencing Variables in Tasks:
In tasks, you use the {{ ... }} syntax to reference variables. For example:

    ```yaml
    ---
    - name: Display Variable
      hosts: localhost
      vars:
        my_variable: "Hello, Ansible!"
      tasks:
        - name: Print Variable
          debug:
            var: "{{ my_variable }}
    ```
    In this example, my_variable is referenced as {{ my_variable }} in the debug task.

2. Referencing Nested Variables:
If you have nested variables (e.g., dictionaries or lists), you can reference their elements using dot notation or square brackets:

    ```yaml
    ---
    - name: Reference Nested Variables
      hosts: localhost
      vars:
        my_dict:
          key1: "value1"
          key2: "value2"
      tasks:
        - name: Print Nested Variable
          debug:
            var: "{{ my_dict.key1 }}"
    ```
3. Referencing Variables in Expressions:
You can reference variables within expressions to perform operations or concatenate strings:

    ```yaml
    ---
    - name: Reference Variable in Expression
      hosts: localhost
      vars:
        first_name: "John"
        last_name: "Doe"
      tasks:
        - name: Combine Variables
          debug:
            msg: "Full Name: {{ first_name }} {{ last_name }}"
    ```

4. Referencing Facts:
Facts are accessed using ansible_facts['fact_name']:

    ```yaml
    ---
    - name: Reference Facts
      hosts: localhost
      tasks:
        - name: Display Hostname
          debug:
            msg: "Hostname is {{ ansible_facts['hostname'] }}"
    ```


### 1. Playbook Variables (local)

User-defined playbook variables in Ansible are variables that are explicitly defined within a playbook using the vars keyword. These variables are specific to the playbook and can be used to parameterize tasks, making playbooks more flexible and reusable.

  Sytnax

  ```yaml
  ---
  - name:
    hosts:
    # Local Variable
    vars:
      httpd_package: httpd
      index_file: index.html

    tasks:
      - name: Install httd
        yum:
          name: "{{ httpd_package }}" # usage: metion the var name between "{{ }}"
          state: present
      - name: copy index.html
        copy:
          src: :{{ index_file }}"
          dest: /var/www/html/{{ index_file }} # if there is anything present before the variable mentioed , then no need to use double quotes
  ```

### 2. Group Variables
when you want to provide varibles to be passed based on the group that the host is defined in , then we use grouped variables

eg , suppose we have 2 groups webserver and dbserver in hosts file. We need to install httpd application on webserver and mysql on dbserver group 
```yaml
[webserver]
192.168.32.144
192.168.32.145
[dbserver]
192.168.32.149
192.168.32.150
```

- Create a directory called as group_vars in the same location as the hosts file 
- to define group variables, you need to create yaml files with the same name of the groups mentioned in hosts file
- to target all the groups present in the hosts(including ungrouped) , we will create a file named as all.yaml
- all.yaml has the last priority
```/etc/ansible/group_vars``` 
```markdown
/etc/ansible/
          ├── hosts
          └── group_vars/
              ├── webserver.yml
              ├── dbserver.yml
              └── all.yml
```
- To define the variables , just mention it in the yaml file that was created above
```yaml
#webserver.yaml
package_name: httpd

#dbserver.yaml
package_name: mysql
```
- useage
```yaml
---
- name: group vars example
  hosts: all

  tasks:
  - name: install service
    yum:
      name: "{{ package_name }}"
      state: present
```
in the above example we have not mentioedn the varibale in the playbook directly , but only in the yaml files present in group_vars directory. when the playbook runs , it will map the host in the groups with tha yaml files present in the group_vars directory and take the corresponding values present on he yaml files 

- very simillay to thing , if you want to defined variables for specefic hosts , create a dir host_vars , inside which yo need to crate a yaml file based on the ip adress or the dns name of the host and add the variables inside it

### Varibele Precedence

variable precedence determines the order in which variables are evaluated and which value takes precedence when there are multiple sources defining the same variable. Understanding variable precedence is crucial for effective playbook development. 
Here is the general order of variable precedence in Ansible:

1. Extra Variables:

    Variables provided with the -e or --extra-vars command-line option have the highest precedence. They can be set when running the playbook, allowing you to override other variable values.

    ```ansible-playbook your_playbook.yml -e "variable_name=value"```

2. Most Specific to Least Specific:

    Variables defined for a specific host, group, or group of groups take precedence over variables defined for broader categories. 
    The order is as follows (from most specific to least specific):
    - Host variables (highest precedence)
    - Group variables
    - Parent groups' variables
    - all group variables (lowest precedence)

3. Role Defaults:

    Variables defined in role defaults (roles/your_role/defaults/main.yml) are applied if no higher-precedence variables are defined.

4. Block-Scoped Variables:

    - Variables defined within a block or a play using block or vars keywords have precedence within that block or play.

      ```yaml
      ---
      - name: Example Playbook
        hosts: target_hosts
        tasks:
          - name: Task with Block-Scoped Variable
            debug:
              var: block_variable
            vars:
              block_variable: "This is a block-scoped variable"
      ```
5. Inventory File:

    Variables defined in the inventory file (group_vars, host_vars) are processed based on the inventory structure. Group variables take precedence over host variables.

6. Configuration Files:

    Variables defined in Ansible configuration files (ansible.cfg) can provide default values.

    ```ini
    [defaults]
    variable_name = default_value
    ```
7. Environment Variables:

    Variables can be defined as environment variables that Ansible reads.

    ```export ANSIBLE_VARIABLE_NAME=value```

8. Fact Variables:

    - Facts discovered by Ansible (e.g., gathered from the target hosts) can be used as variables with the ansible_facts dictionary.
      ```yaml
      ---
      - name: Example Playbook
        hosts: target_hosts
        tasks:
          - name: Display Hostname
            debug:
              var: ansible_facts['hostname']
      ```

These are the general rules for variable precedence in Ansible. Keep in mind that when a variable is defined at a higher level, it takes precedence over the same variable defined at a lower level. 


## Loops in Ansible
- loops are used to repeat a particular task or set of tasks multiple times, iterating over a list of items. Ansible provides several ways to implement loops in your playbooks. 
- Here are some common methods:

### 1. Looping with with_items (Deprecated) 
<br>
The with_items keyword is a simple way to loop over a list of items. However, it is deprecated in recent Ansible versions, and it is recommended to use the loop keyword instead.

```yaml
---
- name: Looping with with_items
  hosts: localhost
  tasks:
    - name: Print items
      debug:
        msg: "Item: {{ item }}"
      with_items:
        - "item1"
        - "item2"
        - "item3"
```

### 2. Looping with loop (Preferred):
<br>
The loop keyword is the modern and recommended way to implement loops. It is more versatile and supports various loop control parameters.

```yaml
---
- name: Looping with loop
  hosts: localhost
  tasks:
    - name: Print items
      debug:
        msg: "Item: {{ item }}"
      loop:
        - "item1"
        - "item2"
        - "item3"
```
### 3.  Looping over a Range 
<br>
You can use the range function to generate a range of numbers and iterate over them.

```yaml
---
- name: Looping over a range
  hosts: localhost
  tasks:
    - name: Print numbers
      debug:
        msg: "Number: {{ item }}"
      loop: "{{ range(1, 4) | list }}"
```
### 4. Looping over a Dictionary:
<br>
You can loop over the keys or values of a dictionary.

```yaml
---
- name: Looping over a dictionary
  hosts: localhost
  tasks:
    - name: Print key-value pairs
      debug:
        msg: "Key: {{ item.key }}, Value: {{ item.value }}"
      loop: "{{ some_dict | dict2items }}"
```

### 5. Looping with with_nested (Nested Loops):
<br>
Use with_nested to iterate over nested lists.

```yaml
---
- name: Nested Loop
  hosts: localhost
  tasks:
    - name: Print nested items
      debug:
        msg: "Outer: {{ outer_item }}, Inner: {{ inner_item }}"
      with_nested:
        - ["outer1", "outer2"]
        - ["inner1", "inner2"]
```

### 6. Looping with with_items in Tasks (Deprecated) 
<br>
Looping within a task is deprecated, but it still works. However, it is recommended to use the loop keyword.

```yaml
---
- name: Looping within a task
  hosts: localhost
  tasks:
    - name: Print items
      debug:
        msg: "Item: {{ item }}"
      with_items:
        - "item1"
        - "item2"
        - "item3"
```

## Installig multiple packages using loops
```yaml
---
- name: install multiple packages wth loop
  hosts: all
  vars:
    package_list:
      - httpd
      - python3
      - git
      - jenkins
      - java
      - maven
  tasks:
    - name: install packages
      yum:
       name: "{{ item }}" # item is a fixed word to represent each elem of the list
       state: present
      loop: "{{ package_list }}" 
```
## Ansible Vault
Ansible Vault is a feature that allows you to encrypt sensitive information within your Ansible playbooks or roles. This helps in securing sensitive data, such as passwords, API keys, and other secrets, that you might need to include in your configuration files. Ansible Vault uses symmetric-key encryption, and you can decrypt the data when running your playbooks.

Here are the basic steps to use Ansible Vault:

1. **Encrypting a File:**
You can use the ansible-vault encrypt command to encrypt a file containing sensitive information.

    ```ansible-vault encrypt secret.yml```

    This command prompts you to enter a password, which you'll need to provide whenever you want to decrypt or edit the encrypted file.

2. **Editing an Encrypted File:**
To edit an encrypted file, use the ansible-vault edit command.

    ```ansible-vault edit secret.yml```

    This command decrypts the file, opens it in your default editor, and re-encrypts it when you save and close the editor.

3. **Decrypting a File:**
To decrypt a file temporarily for viewing or editing, use the ansible-vault view or ansible-vault decrypt command.

    ```ansible-vault view secret.yml```

    ```ansible-vault decrypt secret.yml```

    Both commands prompt for the password.

4. **Creating a File with encryption:**
To create a file with encyyption .

    ```ansible-vault create secret.yml```
